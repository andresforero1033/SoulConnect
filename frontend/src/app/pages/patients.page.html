<header class="topbar">
  <div class="page-title">
    <p>Panel cl√≠nico</p>
    <h1>Gesti√≥n de pacientes</h1>
  </div>
  <div class="top-actions">
    <div class="stat-chip">
      <span class="material-symbols-rounded">group</span>
      {{ filtered.length }} pacientes
    </div>
    <div class="stat-chip ghost">
      <span class="material-symbols-rounded">hourglass_bottom</span>
      Turnos pr√≥ximos
    </div>
  </div>
</header>

<div class="toast-container">
  <div *ngFor="let t of toasts" class="toast" [ngClass]="t.type">
    {{ t.message }}
  </div>
</div>

<main class="workspace">
  <section class="card form-panel">
    <div class="card-header">
      <div>
        <p class="eyebrow">{{ editingId ? 'Editar registro' : 'Nuevo registro' }}</p>
        <h2>Paciente</h2>
        <p>Completa los datos para crear o actualizar un registro.</p>
      </div>
      <span class="tag">
        <span class="material-symbols-rounded">lock</span>
        Datos cifrados
      </span>
    </div>

    <form [formGroup]="patientForm" (ngSubmit)="onSubmit()" class="form-grid">
      <div class="form-group">
        <label for="firstName">Nombre</label>
        <input id="firstName" type="text" formControlName="firstName" placeholder="Ej. Ana" />
      </div>
      <div class="form-group">
        <label for="lastName">Apellido</label>
        <input id="lastName" type="text" formControlName="lastName" placeholder="Ej. Perez" />
      </div>

      <div class="form-group">
        <label for="sexBiological">Sexo biol√≥gico</label>
        <select id="sexBiological" formControlName="sexBiological">
          <option value="">Selecciona</option>
          <option value="Masculino">Masculino</option>
          <option value="Femenino">Femenino</option>
          <option value="Intersexual">Intersexual</option>
          <option value="Otro">Otro</option>
          <option value="Prefiero no decir">Prefiero no decir</option>
        </select>
      </div>

      <div class="form-group">
        <label for="genderIdentity">Identidad de g√©nero</label>
        <select id="genderIdentity" formControlName="genderIdentity">
          <option value="">Selecciona</option>
          <option value="Mujer">Mujer</option>
          <option value="Hombre">Hombre</option>
          <option value="No binario">No binario</option>
          <option value="Transg√©nero">Transg√©nero</option>
          <option value="Interg√©nero">Interg√©nero</option>
          <option value="Prefiero no decir">Prefiero no decir</option>
        </select>
      </div>

      <div class="form-group">
        <label for="maritalStatus">Estado civil</label>
        <select id="maritalStatus" formControlName="maritalStatus">
          <option value="">Selecciona</option>
          <option value="Soltero/a">Soltero/a</option>
          <option value="Casado/a">Casado/a</option>
          <option value="Uni√≥n libre">Uni√≥n libre</option>
          <option value="Separado/a">Separado/a</option>
          <option value="Divorciado/a">Divorciado/a</option>
          <option value="Viudo/a">Viudo/a</option>
        </select>
      </div>

      <div class="form-group">
        <label for="educationLevel">Escolaridad</label>
        <select id="educationLevel" formControlName="educationLevel">
          <option value="">Selecciona</option>
          <option value="Ninguna">Ninguna</option>
          <option value="Primaria">Primaria</option>
          <option value="Secundaria">Secundaria</option>
          <option value="T√©cnica/Tecnol√≥gica">T√©cnica/Tecnol√≥gica</option>
          <option value="Universitaria">Universitaria</option>
          <option value="Posgrado">Posgrado</option>
        </select>
      </div>

      <div class="form-group">
        <label for="identificationType">Tipo ID</label>
        <select id="identificationType" formControlName="identificationType">
          <option value="CC">CC</option>
          <option value="TI">TI</option>
          <option value="CE">CE</option>
        </select>
      </div>
      <div class="form-group">
        <label for="identificationNumber">Numero ID</label>
        <input id="identificationNumber" type="text" formControlName="identificationNumber" placeholder="Documento" />
      </div>

      <div class="form-group">
        <label for="dateOfBirth">Fecha de nacimiento</label>
        <input id="dateOfBirth" type="date" formControlName="dateOfBirth" [class.invalid]="isInvalid('dateOfBirth')" />
        <div class="error" *ngIf="patientForm.get('dateOfBirth')?.errors?.['futureDate'] && (patientForm.get('dateOfBirth')?.dirty || patientForm.get('dateOfBirth')?.touched)">
          Fecha en el futuro no valida
        </div>
        <div class="error" *ngIf="patientForm.get('dateOfBirth')?.errors?.['required'] && (patientForm.get('dateOfBirth')?.dirty || patientForm.get('dateOfBirth')?.touched)">
          Fecha obligatoria
        </div>
      </div>

      <div class="form-group">
        <label for="email">Email</label>
        <input id="email" type="email" formControlName="email" placeholder="opcional" [class.invalid]="isInvalid('email')" />
        <div class="error" *ngIf="patientForm.get('email')?.errors?.['email'] && (patientForm.get('email')?.dirty || patientForm.get('email')?.touched)">
          Email invalido
        </div>
      </div>
      <div class="form-group">
        <label for="phoneNumber">Telefono</label>
        <input id="phoneNumber" type="tel" formControlName="phoneNumber" placeholder="opcional" />
      </div>

      <div class="form-group">
        <label for="eps">EPS</label>
        <div class="typeahead">
          <input
            id="eps"
            type="text"
            formControlName="eps"
            placeholder="Busca o selecciona EPS"
            autocomplete="off"
            (input)="onEpsInput($event.target.value)"
            (focus)="epsDropdownOpen = true"
            (blur)="closeEpsDropdown()"
          />
          <div class="dropdown" *ngIf="epsDropdownOpen && filteredEps.length > 0">
            <button type="button" *ngFor="let option of filteredEps" (mousedown)="onSelectEps(option)">
              <span class="name">{{ option }}</span>
            </button>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="address">Direcci√≥n</label>
        <input id="address" type="text" formControlName="address" placeholder="Calle 123 #45-67" />
      </div>

      <div class="form-group">
        <label for="location">Ciudad / municipio</label>
        <div class="typeahead">
          <input
            id="location"
            type="text"
            formControlName="location"
            placeholder="Busca por ciudad o departamento"
            autocomplete="off"
            (input)="onLocationInput($event.target.value)"
            (focus)="locationDropdownOpen = true"
            (blur)="closeLocationDropdown()"
          />
          <div class="dropdown" *ngIf="locationDropdownOpen && filteredLocations.length > 0">
            <button type="button" *ngFor="let loc of filteredLocations" (mousedown)="onSelectLocation(loc)">
              <span class="name">{{ loc.city }}</span>
              <span class="spec">{{ loc.department }}</span>
            </button>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="housingType">Tipo de vivienda</label>
        <select id="housingType" formControlName="housingType">
          <option value="">Selecciona</option>
          <option value="Casa">Casa</option>
          <option value="Apartamento">Apartamento</option>
          <option value="Rural">Rural</option>
          <option value="Otro">Otro</option>
        </select>
      </div>

      <div class="form-group">
        <label for="socioeconomicStratum">Estrato</label>
        <select id="socioeconomicStratum" formControlName="socioeconomicStratum">
          <option value="">Selecciona</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
        </select>
      </div>

      <div class="form-group">
        <label for="residenceDurationMonths">Tiempo de residencia (meses)</label>
        <input id="residenceDurationMonths" type="number" min="0" formControlName="residenceDurationMonths" placeholder="Ej. 12" />
      </div>

      <div class="form-group">
        <label for="bloodType">Tipo de sangre</label>
        <select id="bloodType" formControlName="bloodType">
          <option value="">Selecciona</option>
          <option value="O+">O+</option>
          <option value="O-">O-</option>
          <option value="A+">A+</option>
          <option value="A-">A-</option>
          <option value="B+">B+</option>
          <option value="B-">B-</option>
          <option value="AB+">AB+</option>
          <option value="AB-">AB-</option>
        </select>
      </div>

      <div class="form-group">
        <label for="heightCm">Altura (cm)</label>
        <input id="heightCm" type="number" step="0.1" min="0" formControlName="heightCm" placeholder="Ej. 172" />
      </div>

      <div class="form-group">
        <label for="weightKg">Peso (kg)</label>
        <input id="weightKg" type="number" step="0.1" min="0" formControlName="weightKg" placeholder="Ej. 70" />
      </div>

      <div class="form-group">
        <label for="allergies">Alergias</label>
        <textarea id="allergies" formControlName="allergies" placeholder="Registra alergias conocidas"></textarea>
      </div>

      <div class="form-group">
        <label for="medications">Medicamentos actuales</label>
        <textarea id="medications" formControlName="medications" placeholder="Medicamentos en curso"></textarea>
      </div>

      <div class="form-group">
        <label for="surgeries">Antecedentes quir√∫rgicos</label>
        <textarea id="surgeries" formControlName="surgeries" placeholder="Cirug√≠as previas"></textarea>
      </div>

      <div class="form-group">
        <label for="familyHistory">Antecedentes familiares</label>
        <textarea id="familyHistory" formControlName="familyHistory" placeholder="Enfermedades familiares"></textarea>
      </div>

      <div class="form-group">
        <label for="habits">H√°bitos (tabaco, alcohol, actividad)</label>
        <textarea id="habits" formControlName="habits" placeholder="H√°bitos relevantes"></textarea>
      </div>

      <div class="form-group">
        <label for="vaccines">Vacunas</label>
        <textarea id="vaccines" formControlName="vaccines" placeholder="Vacunas aplicadas"></textarea>
      </div>

      <div class="form-group">
        <label for="chronicConditions">Condiciones cr√≥nicas</label>
        <textarea id="chronicConditions" formControlName="chronicConditions" placeholder="Enfermedades cr√≥nicas"></textarea>
      </div>

      <div class="actions">
        <button class="btn-primary" type="submit" [disabled]="patientForm.invalid">
          <span class="material-symbols-rounded">save</span>
          {{ editingId ? 'Actualizar' : 'Guardar' }}
        </button>
        <button *ngIf="editingId" type="button" class="btn-secondary" (click)="cancelEdit()">
          <span class="material-symbols-rounded">close</span>
          Cancelar
        </button>
      </div>
    </form>
  </section>

  <section class="card list-panel">
    <div class="card-header">
      <div>
        <p class="eyebrow">Base activa</p>
        <h2>Pacientes</h2>
        <p>Lista paginada con b√∫squeda r√°pida.</p>
      </div>
      <div class="search-box">
        <span class="material-symbols-rounded">search</span>
        <input type="text" placeholder="Buscar por nombre o ID" (input)="onSearch($event.target.value)" />
      </div>
    </div>

    <div class="pagination-bar">
      <button type="button" (click)="goToPage(page - 1)" [disabled]="page <= 1">Anterior</button>
      <span>Pagina {{ page }} / {{ totalPages }}</span>
      <button type="button" (click)="goToPage(page + 1)" [disabled]="page >= totalPages">Siguiente</button>
    </div>

    <div *ngIf="paged.length === 0" class="empty-state">
      <div class="empty-illustration">ü©∫</div>
      <p>No encontramos pacientes con ese nombre. ¬øDeseas registrar uno nuevo?</p>
    </div>

    <div class="table-wrapper" *ngIf="paged.length > 0">
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Apellido</th>
            <th>Tipo ID</th>
            <th>Numero</th>
            <th>Fecha nac.</th>
            <th>Email</th>
            <th>Telefono</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of paged" (click)="navigateToPatientDetail(p)" style="cursor:pointer">
            <td>{{ p.firstName }}</td>
            <td>{{ p.lastName }}</td>
            <td>{{ p.identificationType }}</td>
            <td>{{ p.identificationNumber }}</td>
            <td>{{ p.dateOfBirth || '‚Äî' }}</td>
            <td>{{ p.email || '‚Äî' }}</td>
            <td>{{ p.phoneNumber || '‚Äî' }}</td>
            <td>
              <div class="table-actions">
                <button type="button" class="icon-button" (click)="$event.stopPropagation(); startEdit(p)" title="Editar">
                  <span class="material-symbols-rounded">edit</span>
                </button>
                <button type="button" class="icon-button secondary" (click)="$event.stopPropagation(); navigateToAppointments(p)" title="Ver citas">
                  <span class="material-symbols-rounded">event</span>
                </button>
                <button type="button" class="icon-button" (click)="$event.stopPropagation(); onDelete(p.id)" title="Eliminar">
                  <span class="material-symbols-rounded">delete</span>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</main>
