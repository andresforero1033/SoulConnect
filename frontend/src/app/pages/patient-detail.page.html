<header class="topbar">
  <div class="page-title">
    <p>Paciente</p>
    <h1 *ngIf="patient">{{ patient.firstName }} {{ patient.lastName }}</h1>
    <p *ngIf="patient">{{ patient.identificationType }} ¬∑ {{ patient.identificationNumber }}</p>
  </div>
  <div class="top-actions">
    <div class="stat-chip">
      <span class="material-symbols-rounded">event</span>
      {{ appointments.length }} citas
    </div>
    <button class="btn-secondary" type="button" (click)="goBack()">
      <span class="material-symbols-rounded">arrow_back</span>
      Volver a pacientes
    </button>
  </div>
</header>

<div class="toast-container">
  <div *ngFor="let t of toasts" class="toast" [ngClass]="t.type">
    {{ t.message }}
  </div>
</div>

<main class="workspace patient-detail full-width">
  <div class="section-grid">
    <section class="card form-panel">
    <div class="card-header">
      <div>
        <p class="eyebrow">Ficha cl√≠nica</p>
        <h2>Datos personales</h2>
        <p>Actualiza informaci√≥n administrativa y cl√≠nica b√°sica.</p>
      </div>
    </div>

      <form [formGroup]="patientForm" (ngSubmit)="savePatient()" class="form-grid">
      <div class="form-group">
        <label for="firstName">Nombre</label>
        <input id="firstName" type="text" formControlName="firstName" />
      </div>
      <div class="form-group">
        <label for="lastName">Apellido</label>
        <input id="lastName" type="text" formControlName="lastName" />
      </div>
      <div class="form-group">
        <label for="identificationType">Tipo ID</label>
        <select id="identificationType" formControlName="identificationType">
          <option value="CC">CC</option>
          <option value="TI">TI</option>
          <option value="CE">CE</option>
        </select>
      </div>
      <div class="form-group">
        <label for="identificationNumber">N√∫mero ID</label>
        <input id="identificationNumber" type="text" formControlName="identificationNumber" />
      </div>
      <div class="form-group">
        <label for="dateOfBirth">Fecha de nacimiento</label>
        <input id="dateOfBirth" type="date" formControlName="dateOfBirth" />
      </div>
      <div class="form-group">
        <label for="email">Email</label>
        <input id="email" type="email" formControlName="email" />
      </div>
      <div class="form-group">
        <label for="phoneNumber">Tel√©fono</label>
        <input id="phoneNumber" type="tel" formControlName="phoneNumber" />
      </div>
      <div class="form-group">
        <label for="eps">EPS</label>
        <input id="eps" type="text" formControlName="eps" />
      </div>
      <div class="form-group">
        <label for="address">Direcci√≥n</label>
        <input id="address" type="text" formControlName="address" />
      </div>
      <div class="form-group">
        <label for="bloodType">Tipo de sangre</label>
        <input id="bloodType" type="text" formControlName="bloodType" placeholder="Ej. O+" />
      </div>
      <div class="form-group">
        <label for="heightCm">Altura (cm)</label>
        <input id="heightCm" type="number" step="0.1" min="0" formControlName="heightCm" />
      </div>
      <div class="form-group">
        <label for="weightKg">Peso (kg)</label>
        <input id="weightKg" type="number" step="0.1" min="0" formControlName="weightKg" />
      </div>
      <div class="form-group">
        <label>IMC</label>
        <div class="bmi-box">{{ bmi || '‚Äî' }}</div>
        <small class="hint">IMC = peso (kg) / estatura (m)¬≤</small>
      </div>
      <div class="actions">
        <button class="btn-primary" type="submit" [disabled]="patientForm.invalid">
          <span class="material-symbols-rounded">save</span>
          Guardar cambios
        </button>
      </div>
      </form>
    </section>

    <section class="card form-panel">
    <div class="card-header">
      <div>
        <p class="eyebrow">Antecedentes y salud</p>
        <h2>Informaci√≥n m√©dica</h2>
      </div>
    </div>

      <form [formGroup]="patientForm" class="form-grid">
      <div class="form-group">
        <label for="sexBiological">Sexo biol√≥gico</label>
        <input id="sexBiological" type="text" formControlName="sexBiological" />
      </div>
      <div class="form-group">
        <label for="genderIdentity">Identidad de g√©nero</label>
        <input id="genderIdentity" type="text" formControlName="genderIdentity" />
      </div>
      <div class="form-group">
        <label for="maritalStatus">Estado civil</label>
        <input id="maritalStatus" type="text" formControlName="maritalStatus" />
      </div>
      <div class="form-group">
        <label for="educationLevel">Escolaridad</label>
        <input id="educationLevel" type="text" formControlName="educationLevel" />
      </div>
      <div class="form-group">
        <label for="occupation">Ocupaci√≥n</label>
        <input id="occupation" type="text" formControlName="occupation" />
      </div>
      <div class="form-group">
        <label for="emergencyContactName">Contacto de emergencia</label>
        <input id="emergencyContactName" type="text" formControlName="emergencyContactName" />
      </div>
      <div class="form-group">
        <label for="emergencyContactPhone">Tel√©fono emergencia</label>
        <input id="emergencyContactPhone" type="tel" formControlName="emergencyContactPhone" />
      </div>
      <div class="form-group">
        <label for="city">Ciudad</label>
        <input id="city" type="text" formControlName="city" />
      </div>
      <div class="form-group">
        <label for="municipality">Municipio</label>
        <input id="municipality" type="text" formControlName="municipality" />
      </div>
      <div class="form-group">
        <label for="neighborhood">Barrio/Localidad</label>
        <input id="neighborhood" type="text" formControlName="neighborhood" />
      </div>
      <div class="form-group">
        <label for="postalCode">C√≥digo postal</label>
        <input id="postalCode" type="text" formControlName="postalCode" />
      </div>
      <div class="form-group">
        <label for="housingType">Tipo de vivienda</label>
        <input id="housingType" type="text" formControlName="housingType" />
      </div>
      <div class="form-group">
        <label for="socioeconomicStratum">Estrato</label>
        <input id="socioeconomicStratum" type="text" formControlName="socioeconomicStratum" />
      </div>
      <div class="form-group">
        <label for="residenceDurationMonths">Tiempo de residencia (meses)</label>
        <input id="residenceDurationMonths" type="number" min="0" formControlName="residenceDurationMonths" />
      </div>

      <div class="form-group">
        <label for="abdominalCircumferenceCm">Per√≠metro abdominal (cm)</label>
        <input id="abdominalCircumferenceCm" type="number" step="0.1" min="0" formControlName="abdominalCircumferenceCm" />
      </div>
      <div class="form-group">
        <label for="heartRateBpm">Frecuencia cardiaca (lpm)</label>
        <input id="heartRateBpm" type="number" min="0" formControlName="heartRateBpm" />
      </div>
      <div class="form-group">
        <label for="respiratoryRateRpm">Frecuencia respiratoria (rpm)</label>
        <input id="respiratoryRateRpm" type="number" min="0" formControlName="respiratoryRateRpm" />
      </div>
      <div class="form-group">
        <label for="bloodPressureSys">Presi√≥n sist√≥lica</label>
        <input id="bloodPressureSys" type="number" min="0" formControlName="bloodPressureSys" />
      </div>
      <div class="form-group">
        <label for="bloodPressureDia">Presi√≥n diast√≥lica</label>
        <input id="bloodPressureDia" type="number" min="0" formControlName="bloodPressureDia" />
      </div>
      <div class="form-group">
        <label for="temperatureC">Temperatura (¬∞C)</label>
        <input id="temperatureC" type="number" step="0.1" min="0" formControlName="temperatureC" />
      </div>
      <div class="form-group">
        <label for="spo2">SpO2 (%)</label>
        <input id="spo2" type="number" step="0.1" min="0" formControlName="spo2" />
      </div>

      <div class="form-group">
        <label for="allergies">Alergias</label>
        <textarea id="allergies" formControlName="allergies"></textarea>
      </div>
      <div class="form-group">
        <label for="medications">Medicamentos actuales</label>
        <textarea id="medications" formControlName="medications"></textarea>
      </div>
      <div class="form-group">
        <label for="surgeries">Antecedentes quir√∫rgicos</label>
        <textarea id="surgeries" formControlName="surgeries"></textarea>
      </div>
      <div class="form-group">
        <label for="familyHistory">Antecedentes familiares</label>
        <textarea id="familyHistory" formControlName="familyHistory"></textarea>
      </div>
      <div class="form-group">
        <label for="habits">H√°bitos (tabaco, alcohol, actividad)</label>
        <textarea id="habits" formControlName="habits"></textarea>
      </div>
      <div class="form-group">
        <label for="vaccines">Vacunas</label>
        <textarea id="vaccines" formControlName="vaccines"></textarea>
      </div>
      <div class="form-group">
        <label for="chronicConditions">Condiciones cr√≥nicas</label>
        <textarea id="chronicConditions" formControlName="chronicConditions"></textarea>
      </div>
      </form>
    </section>
  </div>

  <section class="card appointments-panel">
    <div class="card-header">
      <div>
        <p class="eyebrow">Citas</p>
        <h2>Historial y agendamiento</h2>
        <p *ngIf="patient">{{ patient.firstName }} {{ patient.lastName }} ¬∑ {{ patient.identificationNumber }}</p>
      </div>
      <span class="tag">
        <span class="material-symbols-rounded">schedule</span>
        {{ appointments.length }} citas
      </span>
    </div>

    <div class="appointments-body">
      <form [formGroup]="appointmentForm" (ngSubmit)="saveAppointment()" class="form-grid appointments-form">
        <div class="form-group">
          <label for="appointmentDate">Fecha</label>
          <input id="appointmentDate" type="date" formControlName="date" />
        </div>
        <div class="form-group">
          <label for="appointmentTime">Hora</label>
          <input id="appointmentTime" type="time" formControlName="time" />
        </div>
        <div class="form-group">
          <label for="specialty">Especialidad</label>
          <div class="typeahead">
            <input
              id="specialty"
              type="text"
              formControlName="specialty"
              placeholder="Busca o selecciona"
              autocomplete="off"
              (input)="onSpecialtyInput($event.target.value)"
              (focus)="typeDropdownOpen = true"
              (blur)="closeTypeDropdown()"
            />
            <div class="dropdown" *ngIf="typeDropdownOpen && filteredTypes.length > 0">
              <button type="button" *ngFor="let t of filteredTypes" (mousedown)="onSelectType(t)">
                <span class="code">{{ t.code }}</span>
                <span class="name">{{ t.name }}</span>
                <span class="spec">{{ t.specialty }}</span>
              </button>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="status">Estado</label>
          <select id="status" formControlName="status">
            <option *ngFor="let s of statusOptions" [value]="s">{{ s }}</option>
          </select>
        </div>
        <div class="actions">
          <button class="btn-primary" type="submit" [disabled]="appointmentForm.invalid">
            <span class="material-symbols-rounded">{{ editingAppointmentId ? 'save' : 'add' }}</span>
            {{ editingAppointmentId ? 'Actualizar cita' : 'Agendar' }}
          </button>
          <button *ngIf="editingAppointmentId" type="button" class="btn-secondary" (click)="cancelAppointmentEdit()">
            <span class="material-symbols-rounded">close</span>
            Cancelar
          </button>
        </div>
      </form>

      <div *ngIf="appointments.length === 0" class="empty-state compact">
        <div class="empty-illustration">üóíÔ∏è</div>
        <p>Sin citas registradas para este paciente.</p>
      </div>

      <h3 *ngIf="pendingAppointments.length">Citas pendientes</h3>
      <div class="table-wrapper" *ngIf="pendingAppointments.length > 0">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Especialidad</th>
              <th>Estado</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let a of pendingAppointments">
              <td>{{ a.date }}</td>
              <td>{{ a.time }}</td>
              <td>{{ a.specialty }}</td>
              <td>{{ a.status }}</td>
              <td>
                <div class="table-actions">
                  <button type="button" class="icon-button" (click)="startEditAppointment(a)" title="Editar cita">
                    <span class="material-symbols-rounded">edit</span>
                  </button>
                  <button type="button" class="icon-button" (click)="deleteAppointment(a.id)" title="Eliminar cita">
                    <span class="material-symbols-rounded">delete</span>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <h3 *ngIf="pastAppointments.length">Citas pasadas</h3>
      <div class="table-wrapper" *ngIf="pastAppointments.length > 0">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Especialidad</th>
              <th>Estado</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let a of pastAppointments">
              <td>{{ a.date }}</td>
              <td>{{ a.time }}</td>
              <td>{{ a.specialty }}</td>
              <td>{{ a.status }}</td>
              <td>
                <div class="table-actions">
                  <button type="button" class="icon-button" (click)="startEditAppointment(a)" title="Editar cita">
                    <span class="material-symbols-rounded">edit</span>
                  </button>
                  <button type="button" class="icon-button" (click)="deleteAppointment(a.id)" title="Eliminar cita">
                    <span class="material-symbols-rounded">delete</span>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</main>
