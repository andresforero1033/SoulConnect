<header class="topbar">
  <div class="page-title">
    <p>Agenda</p>
    <h1>Gesti√≥n de citas</h1>
  </div>
  <div class="top-actions">
    <div class="stat-chip">
      <span class="material-symbols-rounded">schedule</span>
      {{ appointments.length }} citas
    </div>
    <div class="stat-chip ghost" role="button" (click)="goToPatients()">
      <span class="material-symbols-rounded">groups</span>
      Ir a pacientes
    </div>
  </div>
</header>

<div class="toast-container">
  <div *ngFor="let t of toasts" class="toast" [ngClass]="t.type">
    {{ t.message }}
  </div>
</div>

<main class="workspace full-width">
  <section class="card form-panel">
    <div class="card-header">
      <div>
        <p class="eyebrow">Selecciona paciente</p>
        <h2>Buscar por documento</h2>
        <p>Escribe el documento del paciente para ver y gestionar sus citas.</p>
      </div>
    </div>

    <form class="form-grid" (ngSubmit)="onSearchByDocument()">
      <div class="form-group">
        <label for="patientDocument">Documento</label>
        <input
          id="patientDocument"
          type="text"
          placeholder="Ingresa el n√∫mero de documento"
          [formControl]="patientLookupControl"
          (input)="onFilterPatients($event.target.value)"
        />
        <small *ngIf="patientLookupControl.invalid && patientLookupControl.touched" class="hint">Ingresa un documento v√°lido</small>
      </div>
      <div class="actions">
        <button type="submit" class="btn-primary">
          <span class="material-symbols-rounded">search</span>
          Buscar
        </button>
        <button type="button" class="btn ghost" (click)="clearSelection()" *ngIf="selectedPatient">
          <span class="material-symbols-rounded">close</span>
          Limpiar
        </button>
        <button type="button" class="btn-secondary" (click)="goToPatients()">
          <span class="material-symbols-rounded">person_add</span>
          Gestionar pacientes
        </button>
      </div>
    </form>

    <div class="table-wrapper" *ngIf="filteredPatients.length > 0">
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Documento</th>
            <th>Seleccionar</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of filteredPatients">
            <td>{{ p.firstName }} {{ p.lastName }}</td>
            <td>{{ p.identificationNumber }}</td>
            <td>
              <button type="button" class="btn-secondary" (click)="setSelectedPatient(p)">
                <span class="material-symbols-rounded">check_circle</span>
                Usar
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <section class="card appointments-panel">
    <div class="card-header">
      <div>
        <p class="eyebrow">Citas</p>
        <h2>Historial y agendamiento</h2>
        <p *ngIf="!selectedPatient">Selecciona un paciente para ver y crear citas.</p>
        <p *ngIf="selectedPatient">{{ selectedPatient.firstName }} {{ selectedPatient.lastName }} ¬∑ {{ selectedPatient.identificationNumber }}</p>
      </div>
      <span class="tag" *ngIf="selectedPatient">
        <span class="material-symbols-rounded">schedule</span>
        {{ appointments.length }} citas
      </span>
    </div>

    <div *ngIf="!selectedPatient" class="empty-state">
      <div class="empty-illustration">üìÖ</div>
      <p>Elige un paciente para gestionar sus citas.</p>
    </div>

    <div *ngIf="selectedPatient" class="appointments-body">
      <form [formGroup]="appointmentForm" (ngSubmit)="onCreateAppointment()" class="form-grid appointments-form">
        <div class="form-group">
          <label for="appointmentDate">Fecha</label>
          <input id="appointmentDate" type="date" formControlName="date" />
        </div>
        <div class="form-group">
          <label for="appointmentTime">Hora</label>
          <input id="appointmentTime" type="time" formControlName="time" />
        </div>
        <div class="form-group">
          <label for="specialty">Especialidad</label>
          <div class="typeahead">
            <input
              id="specialty"
              type="text"
              formControlName="specialty"
              placeholder="Busca o selecciona"
              autocomplete="off"
              (input)="onSpecialtyInput($event.target.value)"
              (focus)="typeDropdownOpen = true"
              (blur)="closeTypeDropdown()"
            />
            <div class="dropdown" *ngIf="typeDropdownOpen && filteredTypes.length > 0">
              <button type="button" *ngFor="let t of filteredTypes" (mousedown)="onSelectType(t)">
                <span class="code">{{ t.code }}</span>
                <span class="name">{{ t.name }}</span>
                <span class="spec">{{ t.specialty }}</span>
              </button>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="status">Estado</label>
          <select id="status" formControlName="status">
            <option *ngFor="let s of statusOptions" [value]="s">{{ s }}</option>
          </select>
        </div>
        <div class="actions">
          <button class="btn-primary" type="submit" [disabled]="appointmentForm.invalid">
            <span class="material-symbols-rounded">add</span>
            Agendar
          </button>
        </div>
      </form>

      <div *ngIf="appointments.length === 0" class="empty-state compact">
        <div class="empty-illustration">üóíÔ∏è</div>
        <p>Sin citas registradas para este paciente.</p>
      </div>

      <div class="table-wrapper" *ngIf="appointments.length > 0">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Especialidad</th>
              <th>Estado</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let a of appointments">
              <td>{{ a.date }}</td>
              <td>{{ a.time }}</td>
              <td>{{ a.specialty }}</td>
              <td>{{ a.status }}</td>
              <td>
                <button type="button" class="icon-button" (click)="onDeleteAppointment(a.id)" title="Eliminar cita">
                  <span class="material-symbols-rounded">delete</span>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</main>
