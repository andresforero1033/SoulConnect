<header class="topbar">
  <div class="page-title">
    <p>Paciente</p>
    <h1 *ngIf="patient">{{ patient.firstName }} {{ patient.lastName }}</h1>
    <p *ngIf="patient">{{ patient.identificationType }} · {{ patient.identificationNumber }}</p>
  </div>
  <div class="top-actions">
    <button class="btn-secondary" type="button" (click)="goBack()">
      <span class="material-symbols-rounded">arrow_back</span>
      Volver a pacientes
    </button>
  </div>
</header>

<div class="toast-container">
  <div *ngFor="let t of toasts" class="toast" [ngClass]="t.type">
    {{ t.message }}
  </div>
</div>

<main class="workspace patient-detail full-width">
  <div class="section-grid">
    <section class="card form-panel">
    <div class="card-header">
      <div>
        <p class="eyebrow">Ficha clínica</p>
        <h2>Datos personales</h2>
        <p>Actualiza información administrativa y clínica básica.</p>
      </div>
    </div>

      <form [formGroup]="patientForm" (ngSubmit)="savePatient()" class="form-grid">
      <div class="form-group">
        <label for="firstName">Nombre</label>
        <input id="firstName" type="text" formControlName="firstName" />
      </div>
      <div class="form-group">
        <label for="lastName">Apellido</label>
        <input id="lastName" type="text" formControlName="lastName" />
      </div>
      <div class="form-group">
        <label for="identificationType">Tipo ID</label>
        <select id="identificationType" formControlName="identificationType">
          <option value="CC">CC</option>
          <option value="TI">TI</option>
          <option value="CE">CE</option>
        </select>
      </div>
      <div class="form-group">
        <label for="identificationNumber">Número ID</label>
        <input id="identificationNumber" type="text" formControlName="identificationNumber" />
      </div>
      <div class="form-group">
        <label for="dateOfBirth">Fecha de nacimiento</label>
        <input id="dateOfBirth" type="date" formControlName="dateOfBirth" />
      </div>
      <div class="form-group">
        <label for="email">Email</label>
        <input id="email" type="email" formControlName="email" />
      </div>
      <div class="form-group">
        <label for="phoneNumber">Teléfono</label>
        <input id="phoneNumber" type="tel" formControlName="phoneNumber" />
      </div>
      <div class="form-group">
        <label for="eps">EPS</label>
        <div class="typeahead">
          <input
            id="eps"
            type="text"
            formControlName="eps"
            placeholder="Busca o selecciona EPS"
            autocomplete="off"
            (input)="onEpsInput($event.target.value)"
            (focus)="epsDropdownOpen = true"
            (blur)="closeEpsDropdown()"
          />
          <div class="dropdown" *ngIf="epsDropdownOpen && filteredEps.length > 0">
            <button type="button" *ngFor="let option of filteredEps" (mousedown)="onSelectEps(option)">
              <span class="name">{{ option }}</span>
            </button>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="address">Dirección</label>
        <input id="address" type="text" formControlName="address" />
      </div>
      <div class="form-group">
        <label for="bloodType">Tipo de sangre</label>
        <select id="bloodType" formControlName="bloodType">
          <option value="">Selecciona</option>
          <option value="O+">O+</option>
          <option value="O-">O-</option>
          <option value="A+">A+</option>
          <option value="A-">A-</option>
          <option value="B+">B+</option>
          <option value="B-">B-</option>
          <option value="AB+">AB+</option>
          <option value="AB-">AB-</option>
        </select>
      </div>
      <div class="form-group">
        <label for="heightCm">Altura (cm)</label>
        <input id="heightCm" type="number" step="0.1" min="0" formControlName="heightCm" />
      </div>
      <div class="form-group">
        <label for="weightKg">Peso (kg)</label>
        <input id="weightKg" type="number" step="0.1" min="0" formControlName="weightKg" />
      </div>
      <div class="form-group">
        <label>IMC</label>
        <div class="bmi-box">{{ bmi || '—' }}</div>
        <small class="hint">IMC = peso (kg) / estatura (m)²</small>
      </div>
      <div class="actions">
        <button class="btn-primary" type="submit" [disabled]="patientForm.invalid">
          <span class="material-symbols-rounded">save</span>
          Guardar cambios
        </button>
      </div>
      </form>
    </section>

    <section class="card form-panel">
    <div class="card-header">
      <div>
        <p class="eyebrow">Antecedentes y salud</p>
        <h2>Información médica</h2>
      </div>
    </div>

      <form [formGroup]="patientForm" class="form-grid">
      <div class="form-group">
        <label for="sexBiological">Sexo biológico</label>
        <select id="sexBiological" formControlName="sexBiological">
          <option value="">Selecciona</option>
          <option value="Masculino">Masculino</option>
          <option value="Femenino">Femenino</option>
          <option value="Intersexual">Intersexual</option>
          <option value="Otro">Otro</option>
          <option value="Prefiero no decir">Prefiero no decir</option>
        </select>
      </div>
      <div class="form-group">
        <label for="genderIdentity">Identidad de género</label>
        <select id="genderIdentity" formControlName="genderIdentity">
          <option value="">Selecciona</option>
          <option value="Mujer">Mujer</option>
          <option value="Hombre">Hombre</option>
          <option value="No binario">No binario</option>
          <option value="Transgénero">Transgénero</option>
          <option value="Intergénero">Intergénero</option>
          <option value="Prefiero no decir">Prefiero no decir</option>
        </select>
      </div>
      <div class="form-group">
        <label for="maritalStatus">Estado civil</label>
        <select id="maritalStatus" formControlName="maritalStatus">
          <option value="">Selecciona</option>
          <option value="Soltero/a">Soltero/a</option>
          <option value="Casado/a">Casado/a</option>
          <option value="Unión libre">Unión libre</option>
          <option value="Separado/a">Separado/a</option>
          <option value="Divorciado/a">Divorciado/a</option>
          <option value="Viudo/a">Viudo/a</option>
        </select>
      </div>
      <div class="form-group">
        <label for="educationLevel">Escolaridad</label>
        <select id="educationLevel" formControlName="educationLevel">
          <option value="">Selecciona</option>
          <option value="Ninguna">Ninguna</option>
          <option value="Primaria">Primaria</option>
          <option value="Secundaria">Secundaria</option>
          <option value="Técnica/Tecnológica">Técnica/Tecnológica</option>
          <option value="Universitaria">Universitaria</option>
          <option value="Posgrado">Posgrado</option>
        </select>
      </div>
      <div class="form-group">
        <label for="occupation">Ocupación</label>
        <input id="occupation" type="text" formControlName="occupation" />
      </div>
      <div class="form-group">
        <label for="emergencyContactName">Contacto de emergencia</label>
        <input id="emergencyContactName" type="text" formControlName="emergencyContactName" />
      </div>
      <div class="form-group">
        <label for="emergencyContactPhone">Teléfono emergencia</label>
        <input id="emergencyContactPhone" type="tel" formControlName="emergencyContactPhone" />
      </div>
      <div class="form-group">
        <label for="location">Ciudad / municipio</label>
        <div class="typeahead">
          <input
            id="location"
            type="text"
            formControlName="location"
            placeholder="Busca por ciudad o departamento"
            autocomplete="off"
            (input)="onLocationInput($event.target.value)"
            (focus)="locationDropdownOpen = true"
            (blur)="closeLocationDropdown()"
          />
          <div class="dropdown" *ngIf="locationDropdownOpen && filteredLocations.length > 0">
            <button type="button" *ngFor="let loc of filteredLocations" (mousedown)="onSelectLocation(loc)">
              <span class="name">{{ loc.city }}</span>
              <span class="spec">{{ loc.department }}</span>
            </button>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="neighborhood">Barrio/Localidad</label>
        <input id="neighborhood" type="text" formControlName="neighborhood" />
      </div>
      <div class="form-group">
        <label for="postalCode">Código postal</label>
        <input id="postalCode" type="text" formControlName="postalCode" />
      </div>
      <div class="form-group">
        <label for="housingType">Tipo de vivienda</label>
        <select id="housingType" formControlName="housingType">
          <option value="">Selecciona</option>
          <option value="Casa">Casa</option>
          <option value="Apartamento">Apartamento</option>
          <option value="Rural">Rural</option>
          <option value="Otro">Otro</option>
        </select>
      </div>
      <div class="form-group">
        <label for="socioeconomicStratum">Estrato</label>
        <select id="socioeconomicStratum" formControlName="socioeconomicStratum">
          <option value="">Selecciona</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
        </select>
      </div>
      <div class="form-group">
        <label for="residenceDurationMonths">Tiempo de residencia (meses)</label>
        <input id="residenceDurationMonths" type="number" min="0" formControlName="residenceDurationMonths" />
      </div>

      <div class="form-group">
        <label for="abdominalCircumferenceCm">Perímetro abdominal (cm)</label>
        <input id="abdominalCircumferenceCm" type="number" step="0.1" min="0" formControlName="abdominalCircumferenceCm" />
      </div>
      <div class="form-group">
        <label for="heartRateBpm">Frecuencia cardiaca (lpm)</label>
        <input id="heartRateBpm" type="number" min="0" formControlName="heartRateBpm" />
      </div>
      <div class="form-group">
        <label for="respiratoryRateRpm">Frecuencia respiratoria (rpm)</label>
        <input id="respiratoryRateRpm" type="number" min="0" formControlName="respiratoryRateRpm" />
      </div>
      <div class="form-group">
        <label for="bloodPressureSys">Presión sistólica</label>
        <input id="bloodPressureSys" type="number" min="0" formControlName="bloodPressureSys" />
      </div>
      <div class="form-group">
        <label for="bloodPressureDia">Presión diastólica</label>
        <input id="bloodPressureDia" type="number" min="0" formControlName="bloodPressureDia" />
      </div>
      <div class="form-group">
        <label for="temperatureC">Temperatura (°C)</label>
        <input id="temperatureC" type="number" step="0.1" min="0" formControlName="temperatureC" />
      </div>
      <div class="form-group">
        <label for="spo2">SpO2 (%)</label>
        <input id="spo2" type="number" step="0.1" min="0" formControlName="spo2" />
      </div>

      <div class="form-group">
        <label for="allergies">Alergias</label>
        <textarea id="allergies" formControlName="allergies"></textarea>
      </div>
      <div class="form-group">
        <label for="medications">Medicamentos actuales</label>
        <textarea id="medications" formControlName="medications"></textarea>
      </div>
      <div class="form-group">
        <label for="surgeries">Antecedentes quirúrgicos</label>
        <textarea id="surgeries" formControlName="surgeries"></textarea>
      </div>
      <div class="form-group">
        <label for="familyHistory">Antecedentes familiares</label>
        <textarea id="familyHistory" formControlName="familyHistory"></textarea>
      </div>
      <div class="form-group">
        <label for="habits">Hábitos (tabaco, alcohol, actividad)</label>
        <textarea id="habits" formControlName="habits"></textarea>
      </div>
      <div class="form-group">
        <label for="vaccines">Vacunas</label>
        <textarea id="vaccines" formControlName="vaccines"></textarea>
      </div>
      <div class="form-group">
        <label for="chronicConditions">Condiciones crónicas</label>
        <textarea id="chronicConditions" formControlName="chronicConditions"></textarea>
      </div>
      </form>
    </section>
  </div>

</main>
